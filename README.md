# Fast Footballer Name Checker

Draft pipeline that:
1) Transcribes audio of fast-spoken footballer names.
2) Extracts names by matching against a dictionary of players.
3) Checks whether all names satisfy a question constraint, using a local database and optional LLM.

## Usage

```bash
python src/cli.py /path/to/audio.wav "Do all players played for Barcelona?"
```

## Options

- `--knowledge path.json|jsonl` to load a local player database (default: `data/players_enriched.jsonl`).
- `--bias-names` to bias Whisper with known names.
- `--allow-last-name` to accept last-name-only matches.
- `--slowdown 0.7` to slow the audio before ASR.
- `--checker rule|llm` to switch between rule-based and LLM-backed checks.

## Knowledge Base

The loader accepts:
- JSON dict: `{ "Player Name": { ...attributes... } }`
- JSON list: `[ { "name": "Player Name", ...attributes... } ]`
- JSONL: one JSON object per line with a `name` field.

Suggested fields:
- `nationality`, `clubs`, `leagues`, `world_cup_years`, `club_history`, `honors`, `aliases`

`club_history` entries use `{ "club": "Name", "from": 2010, "to": 2014 }` where `to` can be null.
`honors` entries use `{ "type": "treble", "club": "Manchester United", "season": "1998-99" }`.

Populate this database with top-5 league players and all World Cup players from your sources.

## Wikidata name list

To build a local JSONL of footballer names from Wikidata:

```bash
python scripts/data_prep/fetch_wikidata_names.py --output wikidata_players.jsonl
```

This script queries the Wikidata SPARQL endpoint and rewrites the output file.

## Wikidata dump extractor

The full dump is large (current `latest-all.json.gz` is about 151 GB). You can
stream-extract names without fully uncompressed storage:

```bash
python scripts/data_prep/extract_wikidata_players.py \
  --path /path/to/latest-all.json.gz \
  --output wikidata_players.jsonl \
  --with-aliases
```

## LLM Checker

The LLM checker uses the knowledge base as context and expects the LLM to return:

```json
{"answer": true, "justification": "..."}
```

Implement an `LLMClient` in `src/llm.py` that calls your preferred LLM provider.

## Notes

- The ASR "constraint" is implemented as biasing + dictionary matching; it does not hard-block all out-of-dictionary words.
- For production-grade name extraction, plug in a proper NER model or a lexical ASR with a full name list.

## ASR prompt bias findings

When using Whisper with an `initial_prompt` built from player names, the output can change dramatically. In our testing with fast name lists:

- Prompting with a player-name list helps Whisper stay in “name mode” and often yields more recognizable names.
- The *order and size* of the name list matter. Different prompt orders can flip results (e.g., English-ish names vs. Arabic-like tokens).
- `verify_names.py` builds a large `known_names` list then takes the first N names for the prompt. If Stage 1 uses a smaller or differently ordered list, results can diverge.
- To keep outputs stable, keep the prompt construction consistent across scripts (same list source, same ordering, same limit). If you see inconsistent results, inspect the prompt head/tail and length with debug output.

## Building a richer player dataset

To merge recent sources into a single JSONL (top‑5 leagues + World Cup players):

```bash
python3 scripts/data_prep/build_players_enriched.py \
  --fbref data/fbref_2025_players.jsonl \
  --transfermarkt data/transfermarkt_players.jsonl \
  --fifa data/fifa_all_players.jsonl \
  --worldcup data/worldcup_players.jsonl \
  --openfootball data/openfootball_players.jsonl \
  --output data/players_enriched.jsonl
```

The script merges by normalized name, prefers more recent sources for overlapping fields, and accumulates clubs/leagues/sources.

## Data sources in this repo

Below are the current datasets used to build and refresh player coverage. “Access points” are the local files and/or scripts that produce them.

- **FBref (recent seasons)**  
  **Description:** Player stats and club/league info for the latest season(s).  
  **Importance:** **High** — most up‑to‑date for current squads; use this to keep the dataset fresh.  
  **Access points:** `data/fbref_2025_players.jsonl`, generated by `scripts/data_prep/fetch_fbref_2025.py`

- **Transfermarkt (historical + market values)**  
  **Description:** Player profiles with nationality, club, league, market values, and identifiers.  
  **Importance:** Medium — useful for enrichment and fame scoring.  
  **Access points:** `data/transfermarkt_players.jsonl`, generated by `scripts/data_prep/fetch_transfermarkt_kaggle.py`

- **FIFA player ratings**  
  **Description:** Ratings, positions, clubs, leagues, and values from FIFA datasets.  
  **Importance:** Medium — good for positions/ratings; can be dated.  
  **Access points:** `data/fifa_all_players.jsonl`, generated by `scripts/data_prep/fetch_fifa_players.py`

- **World Cup players (historical)**  
  **Description:** Names of World Cup participants across history.  
  **Importance:** High — ensures historical coverage beyond recent leagues.  
  **Access points:** `data/worldcup_players.jsonl`, generated by `scripts/data_prep/fetch_openfootball.py`

- **OpenFootball names**  
  **Description:** Broad name list (no attributes).  
  **Importance:** Low — name coverage only; useful as a fallback list.  
  **Access points:** `data/openfootball_players.jsonl`, generated by `scripts/data_prep/fetch_openfootball.py`

- **Wikidata (optional, currently empty)**  
  **Description:** Rich, structured data (club history with dates, honors, nationality).  
  **Importance:** High — best source for club history/awards if populated.  
  **Access points:** `data/wikidata_players.jsonl`, generated by `scripts/data_prep/fetch_wikidata_names.py` or `scripts/data_prep/fetch_players_ranked.py`
